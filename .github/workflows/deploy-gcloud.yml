name: Deploy to Google Cloud Run

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      region:
        description: 'Google Cloud region'
        required: false
        default: 'us-central1'
  
  # Trigger on push to main branch
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'imgs/**'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_NAME: vitalflow-radar
  REGION: ${{ github.event.inputs.region || 'us-central1' }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
    
    - name: Configure Docker
      run: |
        gcloud auth configure-docker --quiet
    
    - name: Build Docker image
      run: |
        docker build -t gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
          -t gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest \
          -f Dockerfile.cloudrun .
    
    - name: Push Docker image
      run: |
        docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
        docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest
    
    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
          --region ${{ env.REGION }} \
          --platform managed \
          --allow-unauthenticated \
          --memory 1Gi \
          --cpu 1 \
          --min-instances 0 \
          --max-instances 10 \
          --set-env-vars "VITALFLOW_ENV=production"
    
    - name: Get Service URL
      run: |
        URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
          --region ${{ env.REGION }} \
          --format 'value(status.url)')
        echo "## üöÄ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Service URL:** $URL" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Resource | URL |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-----|" >> $GITHUB_STEP_SUMMARY
        echo "| Dashboard | $URL |" >> $GITHUB_STEP_SUMMARY
        echo "| API Health | $URL/api/health |" >> $GITHUB_STEP_SUMMARY
        echo "| API Docs | $URL/docs |" >> $GITHUB_STEP_SUMMARY

  # Optional: Run health check after deployment
  health-check:
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Health Check
      run: |
        URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
          --region ${{ env.REGION }} \
          --format 'value(status.url)')
        
        echo "Checking health at $URL/api/health"
        
        for i in {1..5}; do
          if curl -sf "$URL/api/health" > /dev/null; then
            echo "‚úÖ Health check passed!"
            exit 0
          fi
          echo "Attempt $i failed, retrying in 10 seconds..."
          sleep 10
        done
        
        echo "‚ùå Health check failed after 5 attempts"
        exit 1
      env:
        REGION: ${{ github.event.inputs.region || 'us-central1' }}
        SERVICE_NAME: vitalflow-radar

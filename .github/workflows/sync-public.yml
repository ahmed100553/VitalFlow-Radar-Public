name: Sync to Public Repository

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      sync_message:
        description: 'Commit message for public repo'
        required: false
        default: 'Sync from private repository'
  
  # Trigger on new releases
  release:
    types: [published]
  
  # Scheduled sync (optional - weekly on Sundays)
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight UTC

jobs:
  sync-to-public:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout private repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y rsync
    
    - name: Create temporary directory
      run: |
        mkdir -p /tmp/public-repo
    
    - name: Run sync script
      run: |
        chmod +x scripts/sync_to_public.sh
        ./scripts/sync_to_public.sh /tmp/public-repo
    
    - name: Verify no secrets present
      run: |
        cd /tmp/public-repo
        
        echo "Checking for .env files..."
        if find . -name ".env" -not -name ".env.example" | grep -q .; then
          echo "âŒ ERROR: .env files found!"
          find . -name ".env" -not -name ".env.example"
          exit 1
        fi
        
        echo "Checking for credential files..."
        if find . -name "*credentials*.json" -o -name "*service-account*.json" | grep -q .; then
          echo "âŒ ERROR: Credential files found!"
          find . -name "*credentials*.json" -o -name "*service-account*.json"
          exit 1
        fi
        
        echo "Checking for API keys in code..."
        if grep -r "sk-[A-Za-z0-9]" . --exclude-dir=node_modules --exclude-dir=.git --exclude="package-lock.json" --exclude="*.lock" 2>/dev/null | grep -q .; then
          echo "âŒ ERROR: Potential API keys found!"
          exit 1
        fi
        
        echo "âœ… Security checks passed!"
    
    - name: Checkout public repository
      uses: actions/checkout@v4
      with:
        repository: ${{'ahmed100553/VitalFlow-Radar-Public'}}  # e.g., 'username/VitalFlow-Radar-Public'
        token: ${{ secrets.PUBLIC_REPO_TOKEN }}
        path: public-repo
    
    - name: Copy synced files to public repo
      run: |
        rsync -av --delete \
          --exclude='.git/' \
          /tmp/public-repo/ public-repo/
    
    - name: Configure git
      run: |
        cd public-repo
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
    
    - name: Commit and push changes
      run: |
        cd public-repo
        git add .
        
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          COMMIT_MSG="${{ github.event.inputs.sync_message }}"
          if [ -z "$COMMIT_MSG" ]; then
            if [ "${{ github.event_name }}" = "release" ]; then
              COMMIT_MSG="Sync release ${{ github.event.release.tag_name }}"
            else
              COMMIT_MSG="Automated sync from private repository"
            fi
          fi
          
          git commit -m "$COMMIT_MSG"
          git push origin main
          
          echo "âœ… Changes pushed to public repository"
        fi
    
    - name: Create summary
      run: |
        echo "## ðŸ”„ Sync Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Synced to Public Repository" >> $GITHUB_STEP_SUMMARY
        echo "Repository: ${{ secrets.PUBLIC_REPO_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Security Checks" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… No .env files" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… No credential files" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… No API keys detected" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        cd /tmp/public-repo
        FILE_COUNT=$(find . -type f | wc -l)
        echo "Files synced: $FILE_COUNT" >> $GITHUB_STEP_SUMMARY
